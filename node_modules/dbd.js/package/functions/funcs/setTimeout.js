const ms = require("ms") 
const resolve = require("../../handlers/resolveProperties") 
const timeout = require("../../handlers/singleTimeout") 

module.exports = async d => {
    const code = d.command.code 
    
    const r = code.split("$setTimeout").length - 1 
    
    const inside = code.split("$setTimeout[")[r].split("]")[0] 
    
    const [duration, timeoutData, pulse] = inside.split(";") 
    
    const time = ms(duration) 
    
    if (!time) return d.error(`❌ Invalid duration for the timeout in \`$setTimeout[${inside}]\``) 
    
    if (pulse && !ms(pulse)) return d.error(`❌ Invalid timeout heartbeat in \`$setTimeout[${inside}]\``) 
    
    const max = ms("21d") 
    
    const object = resolve(timeoutData) 
    
    object.repeatEvery = pulse ? ms(pulse) : undefined 
    object.duration = time  
    object.expiresAt = Date.now() + time 
    object.guildID = d.message.guild ? d.message.guild.id : undefined 
    
    const id = Math.floor(Math.random() * 5993929294848291)
    
    object.id = id 
    
    await d.client.db.set({
        varID: `timeouts_${id}`, 
        variable: "timeoutExpireData", 
        value: object 
    })

    timeout(d.client, object) 
    
    return {
        code: code.replaceLast(`$setTimeout[${inside}]`, "")
    }
}